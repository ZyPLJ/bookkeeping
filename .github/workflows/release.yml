name: å‘å¸ƒç‰ˆæœ¬é€šçŸ¥

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  release:
    runs-on: ubuntu-latest
    
    # æ·»åŠ æƒé™é…ç½®
    permissions:
      contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»ºreleaseï¼‰
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²
    
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰vå‰ç¼€ï¼‰
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
    
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬"
          CHANGELOG="ğŸ‰ é¦–ä¸ªç‰ˆæœ¬å‘å¸ƒï¼\n\n### ä¸»è¦åŠŸèƒ½\n- æ—¥å†è®°è´¦ç³»ç»Ÿ\n- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨\n- ç»Ÿè®¡å›¾è¡¨ç”Ÿæˆ\n- æ•°æ®å¯¼å…¥å¯¼å‡º"
        else
          echo "ä¸Šä¸€ä¸ªæ ‡ç­¾: $PREVIOUS_TAG"
          # ç”Ÿæˆä»ä¸Šä¸€ä¸ªæ ‡ç­¾åˆ°å½“å‰æ ‡ç­¾çš„æäº¤è®°å½•
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD | head -20)
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="### æ›´æ–°å†…å®¹\n- ç‰ˆæœ¬æ›´æ–°å’Œä¼˜åŒ–"
          else
            CHANGELOG="### æ›´æ–°å†…å®¹\n$CHANGELOG"
          fi
        fi
        
        # è½¬ä¹‰æ¢è¡Œç¬¦
        CHANGELOG=$(echo "$CHANGELOG" | sed ':a;N;$!ba;s/\n/\\n/g')
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»ºGitHubå‘å¸ƒ
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        release_name: ç‰ˆæœ¬ ${{ steps.version.outputs.version }}
        body: |
          ## ğŸ“¦ ç‰ˆæœ¬ ${{ steps.version.outputs.version }}
          
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜
          
          **æ–¹æ³•ä¸€ï¼šç›´æ¥ä¸‹è½½**
          - ä¸‹è½½ `bookkeeping.html` æ–‡ä»¶
          - åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å³å¯ä½¿ç”¨
          
          **æ–¹æ³•äºŒï¼šå…‹éš†ä»“åº“**
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd bookkeeping
          # åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ bookkeeping.html
          ```
          
          ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
          - ğŸ“… æ—¥å†å¼è®°è´¦ç•Œé¢
          - ğŸ“Š å¤šç§å›¾è¡¨ç»Ÿè®¡ï¼ˆæŸ±çŠ¶å›¾ã€é¥¼å›¾ã€æŠ˜çº¿å›¾ï¼‰
          - ğŸ“ˆ è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢
          - ğŸ’¾ æ•°æ®æœ¬åœ°å­˜å‚¨
          - ğŸ“¤ æ•°æ®å¯¼å…¥å¯¼å‡º
          - ğŸ¨ ç°ä»£åŒ–UIè®¾è®¡
          
          ### ğŸ› ï¸ æŠ€æœ¯æ ˆ
          - HTML5 + CSS3 + JavaScript
          - IndexedDB æœ¬åœ°å­˜å‚¨
          - Chart.js å›¾è¡¨åº“
          - Font Awesome å›¾æ ‡
          
          ---
          
          **æ„Ÿè°¢ä½¿ç”¨æ—¥å†è®°è´¦ç³»ç»Ÿï¼** ğŸ‰
          
          å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ Issue æˆ– Pull Requestã€‚
        draft: false
        prerelease: false
    
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      run: |
        echo "âœ… ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
        echo "ğŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
